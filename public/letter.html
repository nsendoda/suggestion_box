<!-- public/letter.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>投書</title>
  <meta name="robots" content="noindex"> <!-- 必要なら外してOK -->
  <style>
    :root{--pink:#ff8d8d}
    body{font-family:"Yu Gothic",sans-serif;background:#fafafa;margin:0;padding:20px;color:#333}
    .wrap{max-width:760px;margin:0 auto}
    .card{background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:18px}
    .meta{display:flex;gap:10px;align-items:center;color:#999;font-size:.9rem;margin-bottom:10px}
    .badge{display:inline-block;background:#ffe2e2;color:#c95e5e;border-radius:9999px;padding:.15rem .6rem;font-weight:700}
    .content{white-space:pre-wrap;font-size:1.05rem}
    .actions{margin-top:14px;display:flex;gap:8px}
    .btn{border:none;border-radius:8px;padding:.5rem .9rem;color:#fff;font-weight:700;cursor:pointer}
    .btn-done{background:#4caf50}
    .btn-reject{background:#f44336}
    a{color:var(--pink);text-decoration:none}
    .top{margin:10px 0 16px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top"><a href="/owner/list">◀ 一覧へ</a></div>
    <div class="card">
      <div class="meta">
        <span id="badge" class="badge">…</span>
        <span id="owner"></span>
        <span id="time" style="margin-left:auto"></span>
      </div>
      <div id="content" class="content">読み込み中…</div>
      <div id="ownerActions" class="actions" style="display:none">
        <button id="done"   class="btn btn-done">完了</button>
        <button id="reject" class="btn btn-reject">棄却</button>
      </div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);
  const qs = new URLSearchParams(location.search);
  const id = Number(qs.get('id') || 0);
  let me = null;
  let letter = null;

  const labelFor = (s)=> s==='保持' ? '保留' : s;

  async function getMe(){
    const r = await fetch('/api/me');
    if (r.ok) return r.json();
    return null; // 未ログインでもOK（公開ページのため）
  }

  async function fetchLetter(){
    const r = await fetch(`/api/letters/${id}`);
    if (!r.ok){
      $('content').textContent = `取得エラー (${r.status})`;
      return null;
    }
    return r.json();
  }

  async function refresh(){
    letter = await fetchLetter();
    me = await getMe();

    if (!letter) return;

    $('badge').textContent = `[${labelFor(letter.status)}]`;
    $('owner').textContent = `@${letter.owner_id}`;
    $('time').textContent = new Date(letter.updated_at || letter.created_at).toLocaleString();
    $('content').textContent = letter.content;

    // オーナー本人かつ 保持 のときだけ操作ボタン表示
    const canOperate = !!me && (me.ownerId === letter.owner_id || me.id === letter.owner_id);
    $('ownerActions').style.display = (canOperate && letter.status === '保持') ? 'flex' : 'none';
  }

  async function update(status){
    // me.ownerId を優先
    const ownerId = (me && (me.ownerId || me.id)) || '';
    if (!ownerId){ alert('ログインが必要です'); return; }

    const r = await fetch(`/api/owners/${encodeURIComponent(ownerId)}/letters/${id}/status`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ status })
    });
    if (!r.ok){ alert('更新に失敗しました'); return; }
    refresh();
  }

  $('done').onclick   = ()=> update('完了');
  $('reject').onclick = ()=> update('棄却');

  if (!id){ $('content').textContent='id が不正です'; }
  else    { refresh(); }
</script>
</body>
</html>
