<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ã‚ªãƒ¼ãƒŠãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>

    <!-- ãƒ†ãƒ¼ãƒï¼ˆå‰å›ã® #ãƒã‚¬ãƒãƒ” CSSï¼‰ -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Potta+One&family=Zen+Maru+Gothic:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/negahapi.css" />
    <style>
      /* ã¡ã‚‡ã„è¶³ã— */
      .toolbar {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .spacer {
        flex: 1;
      }
      .close {
        x: -;
      }
      .close {
        background: transparent;
        border: none;
        color: #aaa;
        font-size: 14px;
        cursor: pointer;
      }
      .close:hover {
        color: #fff;
        text-decoration: underline;
      }

      /* ã§ã‹ãƒœã‚¿ãƒ³ + ç¥ç¥­æ„Ÿ */
      .btn-giant {
        font-size: clamp(18px, 2.2vw + 8px, 28px);
        padding: 18px 30px;
        border-radius: 9999px;
        background: linear-gradient(135deg, #ff6aa9, #ff8d8d, #ffb86c);
        color: #fff;
        box-shadow: 0 14px 34px rgba(255, 110, 150, 0.35);
        letter-spacing: 0.04em;
        position: relative;
        overflow: hidden;
        transform: translateZ(0); /* GPU */
        animation: ringPulse 2.4s ease-in-out infinite;
      }
      .btn-giant:hover {
        transform: translateY(-1px) scale(1.02);
      }
      .btn-giant:active {
        transform: translateY(1px) scale(0.99);
      }
      .btn-giant:disabled {
        opacity: 0.65;
        cursor: progress;
        filter: saturate(0.6);
      }

      .btn-giant .ico {
        margin-right: 0.5em;
        filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.15));
      }

      @keyframes ringPulse {
        0% {
          box-shadow: 0 0 0 0 rgba(255, 141, 141, 0.55);
        }
        70% {
          box-shadow: 0 0 0 22px rgba(255, 141, 141, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 141, 141, 0);
        }
      }
    </style>
  </head>
  <body>
    <header class="nav">
      <div class="brand">
        ãƒã‚¬ãƒ†ã‚£ãƒ´ãƒãƒƒãƒ”ã‚£<span class="sub"> æŠ•æ›¸ç®±</span>
      </div>
      <div class="toolbar">
        <button
          id="copyLink"
          class="btn btn-ghost"
          title="è‡ªåˆ†ã®æŠ•æ›¸ãƒšãƒ¼ã‚¸URLã‚’ã‚³ãƒ”ãƒ¼"
        >
          æŠ•æ›¸ãƒšãƒ¼ã‚¸URLã‚’ã‚³ãƒ”ãƒ¼
        </button>
      </div>
    </header>

    <main class="wrap">
      <h1>ã‚ªãƒ¼ãƒŠãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <div class="toolbar" style="margin: 12px 0 20px">
        <button id="draw" class="btn btn-contrast btn-giant">
          <span class="ico">ğŸ‰</span> æŠ•æ›¸ç®±ã‹ã‚‰ä¸€æšå¼•ã
        </button>
        <span class="hint">ä¸Šé™ã«é”ã—ã¦ã„ã‚‹ã¨å¼•ã‘ã¾ã›ã‚“</span>
        <span class="spacer"></span>
        <a class="btn btn-ghost" href="/owner/list">ä¸€è¦§ã‚’è¦‹ã‚‹</a>
      </div>

      <!-- å¼•ã„ãŸã‚«ãƒ¼ãƒ‰ -->
      <section
        id="drawn"
        class="card floaty"
        style="display: none; margin: 10px 0 16px"
      >
        <div class="meta">
          <span id="statusBadge" class="badge keep">ä¿ç•™ä¸­</span>
          <span class="hint" id="drawnTime"></span>
        </div>
        <div
          id="drawnContent"
          style="white-space: pre-wrap; font-size: 16px; margin-top: 8px"
        ></div>
        <div class="actions" style="margin-top: 12px">
          <button class="btn btn-contrast" id="btnDone">å®Œäº†</button>
          <button class="btn btn-primary" id="btnHold">ä¿ç•™</button>
          <button class="btn btn-ghost" id="btnDrop">æ£„å´</button>
          <button class="close" id="btnClose" title="é–‰ã˜ã‚‹ï¼ˆä¿ç•™ã®ã¾ã¾ï¼‰">
            Ã— ã¨ã˜ã‚‹
          </button>
        </div>
      </section>

      <div id="toast" class="hint"></div>
    </main>

    <script>
      // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
      const $ = (id) => document.getElementById(id);
      let ownerId = null;
      let currentId = null;
      let confettiShown = false; // ãƒšãƒ¼ã‚¸å†…ã§æœ€åˆã®ä¸€å›ã ã‘ã‚¯ãƒ©ãƒƒã‚«ãƒ¼

      async function getMe() {
        const r = await fetch("/api/me");
        if (!r.ok) {
          location.href = "/login.html";
          return;
        }
        const { ownerId: me } = await r.json();
        ownerId = me;
        return me;
      }

      function showToast(msg, ms = 1400) {
        const t = $("toast");
        t.textContent = msg;
        setTimeout(() => {
          t.textContent = "";
        }, ms);
      }

      // ===== URLã‚³ãƒ”ãƒ¼ =====
      async function copyMyBoxUrl() {
        const url = `${location.origin}/box.html?o=${encodeURIComponent(
          ownerId
        )}`;
        try {
          await navigator.clipboard.writeText(url);
          showToast("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        } catch {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          const ta = document.createElement("textarea");
          ta.value = url;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
          showToast("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        }
      }

      // ===== ã‚¯ãƒ©ãƒƒã‚«ãƒ¼ï¼ˆè»½é‡ã‚³ãƒ³ãƒ•ã‚§ãƒƒãƒ†ã‚£ï¼‰ =====
      function launchConfetti(duration = 1600, count = 120) {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const dpr = window.devicePixelRatio || 1;
        let w = innerWidth,
          h = innerHeight;
        canvas.style.cssText =
          "position:fixed;inset:0;z-index:9999;pointer-events:none";
        canvas.width = w * dpr;
        canvas.height = h * dpr;
        ctx.scale(dpr, dpr);
        document.body.appendChild(canvas);

        const colors = ["#ff2e92", "#b8ff3e", "#7af0ff", "#ffffff"];
        const P = Array.from({ length: count }, () => ({
          x: Math.random() * w,
          y: -20 - Math.random() * h * 0.2,
          vx: (Math.random() - 0.5) * 3,
          vy: 2 + Math.random() * 3,
          size: 4 + Math.random() * 6,
          rot: Math.random() * Math.PI,
          vr: (Math.random() - 0.5) * 0.2,
          color: colors[Math.floor(Math.random() * colors.length)],
          life: 1,
        }));

        const start = performance.now();
        const g = ctx.createLinearGradient(0, 0, 0, h);
        g.addColorStop(0, "rgba(255,255,255,.2)");
        g.addColorStop(1, "transparent");

        function tick(t) {
          const dt = 16 / 1000;
          const elapsed = t - start;
          ctx.clearRect(0, 0, w, h);
          ctx.fillStyle = g;
          ctx.fillRect(0, 0, w, h * 0.15);

          for (const p of P) {
            p.vy += 0.04;
            p.x += p.vx;
            p.y += p.vy;
            p.rot += p.vr;
            if (elapsed > duration * 0.6) p.life -= 0.02;
            ctx.save();
            ctx.globalAlpha = Math.max(p.life, 0);
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rot);
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
            ctx.restore();
          }
          if (elapsed < duration && P.some((p) => p.life > 0 && p.y < h + 20)) {
            requestAnimationFrame(tick);
          } else {
            canvas.remove();
          }
        }
        requestAnimationFrame(tick);
      }

      // ===== å‹•ä½œ =====

      let drawing = false;

      $("draw").onclick = async () => {
        if (drawing) return;
        drawing = true;
        const btn = $("draw");
        btn.disabled = true;

        try {
          const res = await fetch(`/api/owners/${ownerId}/draw`, {
            method: "POST",
          });
          if (!res.ok) {
            const txt = await res.text();
            alert(`å¼•ã‘ã¾ã›ã‚“ã§ã—ãŸï¼š${res.status}\n${txt.slice(0, 200)}`);
            return;
          }
          const data = await res.json();
          currentId = data.id;
          $("drawnContent").textContent = data.content;
          $("statusBadge").textContent = "ä¿ç•™ä¸­";
          $("drawnTime").textContent = new Date().toLocaleString();
          $("drawn").style.display = "block";

          // â˜…æ¯å›ãƒ‰æ´¾æ‰‹ã«
          megaConfetti();
        } finally {
          drawing = false;
          btn.disabled = false;
        }
      };

      // 3ã¤ã®ãƒœã‚¿ãƒ³
      $("btnDone").onclick = () => updateCurrent("å®Œäº†");
      $("btnDrop").onclick = () => updateCurrent("æ£„å´");
      $("btnHold").onclick = () => updateCurrent("ä¿ç•™"); // è¡¨ç¤ºã¯ä¿ç•™ã€APIã¯ã€Œä¿æŒã€ã«å¤‰æ›

      async function updateCurrent(label) {
        if (!currentId) return;
        const apiStatus = label === "ä¿ç•™" ? "ä¿æŒ" : label; // APIã¯ã€Œä¿æŒã€
        const res = await fetch(
          `/api/owners/${ownerId}/letters/${currentId}/status`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: apiStatus }),
          }
        );
        if (!res.ok) {
          const txt = await res.text();
          alert(`æ›´æ–°å¤±æ•—ï¼š${res.status}\n${txt.slice(0, 200)}`);
          return;
        }
        showToast(`${label}ã«ã—ã¾ã—ãŸ`);
        $("drawn").style.display = "none";
        currentId = null;
      }

      // ã¨ã˜ã‚‹ï¼ˆAPIå‘¼ã°ãªã„ï¼ä¿ç•™ã®ã¾ã¾ï¼‰
      $("btnClose").onclick = () => {
        $("drawn").style.display = "none";
        showToast("ä¿ç•™ã®ã¾ã¾é–‰ã˜ã¾ã—ãŸ");
      };

      // åˆæœŸåŒ–
      (async () => {
        await getMe();
        $("copyLink").onclick = copyMyBoxUrl;
      })();
    </script>
  </body>
</html>
