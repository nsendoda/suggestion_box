<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ã‚ªãƒ¼ãƒŠãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>

    <!-- ãƒ†ãƒ¼ãƒï¼ˆå‰å›ã® #ãƒã‚¬ãƒ CSSï¼‰ -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Potta+One&family=Zen+Maru+Gothic:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/negahapi.css" />
    <style>
      /* ã¡ã‚‡ã„è¶³ã— */
      .toolbar {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .spacer {
        flex: 1;
      }
      .close {
        x: -;
      }
      .close {
        background: transparent;
        border: none;
        color: #aaa;
        font-size: 14px;
        cursor: pointer;
      }
      .close:hover {
        color: #fff;
        text-decoration: underline;
      }

      /* ã§ã‹ãƒœã‚¿ãƒ³ + ç¥ç¥­æ„Ÿ */
      .btn-giant {
        font-size: clamp(18px, 2.2vw + 8px, 28px);
        padding: 18px 30px;
        border-radius: 9999px;
        background: linear-gradient(135deg, #ff6aa9, #ff8d8d, #ffb86c);
        color: #fff;
        box-shadow: 0 14px 34px rgba(255, 110, 150, 0.35);
        letter-spacing: 0.04em;
        position: relative;
        overflow: hidden;
        transform: translateZ(0); /* GPU */
        animation: ringPulse 2.4s ease-in-out infinite;
      }
      .btn-giant:hover {
        transform: translateY(-1px) scale(1.02);
      }
      .btn-giant:active {
        transform: translateY(1px) scale(0.99);
      }
      .btn-giant:disabled {
        opacity: 0.65;
        cursor: progress;
        filter: saturate(0.6);
      }

      .btn-giant .ico {
        margin-right: 0.5em;
        filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.15));
      }

      @keyframes ringPulse {
        0% {
          box-shadow: 0 0 0 0 rgba(255, 141, 141, 0.55);
        }
        70% {
          box-shadow: 0 0 0 22px rgba(255, 141, 141, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 141, 141, 0);
        }
      }

      /* æ—¢å­˜ã®ä¸‹ã«è¿½è¨˜ */
      h1 {
        text-align: center;
      }

      /* ç½®ãæ›ãˆ */
      .toolbar-center {
        display: grid;
        grid-template-columns: 1fr auto 1fr; /* å·¦ã‚¹ãƒšãƒ¼ã‚µ / ã¾ã‚“ä¸­ / å³ãƒªãƒ³ã‚¯ */
        gap: 14px;
        align-items: center;
      }
      .toolbar-center > .center-wrap {
        grid-column: 2; /* ã¾ã‚“ä¸­ã®åˆ—ã‚’å¸¸ã«ä½¿ã† */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        text-align: center;
      }
      .toolbar-center > a {
        grid-column: 3; /* å³ç«¯ã®åˆ— */
        justify-self: end;
      }

      /* ãƒ¢ãƒã‚¤ãƒ«æ™‚ã¯1ã‚«ãƒ©ãƒ ï¼‹å³ä¸‹ã«ãƒªãƒ³ã‚¯ */
      @media (max-width: 560px) {
        .toolbar-center {
          grid-template-columns: 1fr;
        }
        .toolbar-center > a {
          grid-column: auto;
          justify-self: end;
        }
      }

      /* ãƒ­ãƒƒã‚¯ä¸­ã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ï¼ˆä»»æ„ï¼‰ */
      .btn-giant.is-locked {
        opacity: 0.65;
        cursor: not-allowed;
        filter: saturate(0.6);
        animation-play-state: paused;
      }
    </style>
  </head>
  <body>
    <header class="nav">
      <div class="brand">
        æŠ•æ›¸ç®±<span class="sub"> ä¸–ç•Œã®å£°ã‚’è´ãrutubo</span>
      </div>
      <div class="toolbar">
        <button
          id="copyLink"
          class="btn btn-ghost"
          title="è‡ªåˆ†ã®æŠ•æ›¸ãƒšãƒ¼ã‚¸URLã‚’ã‚³ãƒ”ãƒ¼"
        >
          æŠ•æ›¸ãƒšãƒ¼ã‚¸URLã‚’ã‚³ãƒ”ãƒ¼
        </button>
      </div>
    </header>

    <main class="wrap">
      <h1>ã‚ªãƒ¼ãƒŠãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <div class="toolbar toolbar-center" style="margin: 12px 0 20px">
        <div class="center-wrap">
          <button id="draw" class="btn btn-contrast btn-giant">
            <span class="ico">ğŸ‰</span> æŠ•æ›¸ç®±ã‹ã‚‰ä¸€æšå¼•ã
          </button>
          <div class="hint">ä¸Šé™ã«é”ã—ã¦ã„ã‚‹ã¨å¼•ã‘ã¾ã›ã‚“</div>
        </div>

        <!-- å³ç«¯ -->
        <a class="btn btn-ghost" href="/owner/list">ä¸€è¦§ã‚’è¦‹ã‚‹</a>
      </div>

      <!-- å¼•ã„ãŸã‚«ãƒ¼ãƒ‰ -->
      <section
        id="drawn"
        class="card floaty"
        style="display: none; margin: 10px 0 16px"
      >
        <div class="meta">
          <span id="statusBadge" class="badge keep">ä¿ç•™ä¸­</span>
          <span class="hint" id="drawnTime"></span>
        </div>
        <div
          id="drawnContent"
          style="white-space: pre-wrap; font-size: 16px; margin-top: 8px"
        ></div>
        <div class="actions" style="margin-top: 12px">
          <button class="btn btn-contrast" id="btnDone">å®Œäº†</button>
          <button class="btn btn-primary" id="btnHold">ä¿ç•™</button>
          <button class="btn btn-ghost" id="btnDrop">æ£„å´</button>
          <button class="close" id="btnClose" title="é–‰ã˜ã‚‹ï¼ˆä¿ç•™ã®ã¾ã¾ï¼‰">
            Ã— ã¨ã˜ã‚‹
          </button>
          <a
            id="btnTweet"
            class="btn btn-ghost"
            target="_blank"
            rel="noopener"
            style="display: none"
            >X ã§å…±æœ‰</a
          >
        </div>
      </section>

      <div id="toast" class="hint"></div>
    </main>

    <script>
      (() => {
        // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
        const $ = (id) => document.getElementById(id);
        let ownerId = null;
        let ownerDisplayName = null;

        let currentId = null; // â† è¡¨ç¤ºä¸­ã‚«ãƒ¼ãƒ‰ã®IDï¼ˆãƒ­ãƒƒã‚¯åˆ¤å®šã«ä½¿ç”¨ï¼‰
        let drawing = false; // â† é€šä¿¡ã®é€£æ‰“é˜²æ­¢

        /* è¿½åŠ ï¼šãƒ­ãƒƒã‚¯ã®åˆ‡æ›¿ï¼ˆè¦‹ãŸç›®ã‚‚å¤‰æ›´ï¼‰ */
        function setDrawLock(locked) {
          const btn = $("draw");
          if (!btn) return;
          btn.disabled = locked;
          btn.classList.toggle("is-locked", locked);
        }

        function showToast(msg, ms = 1400) {
          const t = $("toast");
          if (!t) return;
          t.textContent = msg;
          setTimeout(() => (t.textContent = ""), ms);
        }

        // è‡ªåˆ†æƒ…å ±
        async function getMe() {
          const r = await fetch("/api/me");
          if (!r.ok) {
            location.href = "/login.html";
            return;
          }
          const me = await r.json(); // { ownerId, displayName? } or { id }
          ownerId = me.ownerId || me.id;
          ownerDisplayName = me.displayName || "@" + ownerId;

          // displayName æœªè¿”å´ã®ç’°å¢ƒå‘ã‘ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚ã‚Œã°ï¼‰
          if (!me.displayName) {
            try {
              const pr = await fetch(`/api/owners/${ownerId}/profile`);
              if (pr.ok) {
                const p = await pr.json();
                if (p.displayName) ownerDisplayName = p.displayName;
              }
            } catch {}
          }
          return ownerId;
        }

        // URL ã‚³ãƒ”ãƒ¼
        async function copyMyBoxUrl() {
          const url = `${location.origin}/box.html?o=${encodeURIComponent(
            ownerId
          )}`;
          try {
            await navigator.clipboard.writeText(url);
            showToast("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
          } catch {
            const ta = document.createElement("textarea");
            ta.value = url;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            ta.remove();
            showToast("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
          }
        }

        // 20 æ–‡å­—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå…¨è§’æ··åœ¨ã–ã£ãã‚Šï¼‰
        function preview20(s) {
          const arr = [...s];
          return arr.length > 20 ? arr.slice(0, 20).join("") + "â€¦" : s;
        }

        // ===== ãƒ‰æ´¾æ‰‹ã‚³ãƒ³ãƒ•ã‚§ãƒƒãƒ†ã‚£ï¼ˆæ¯å›ç™ºç«OKï¼‰ =====
        function megaConfetti({
          duration = 2200,
          bursts = 3,
          particles = 220,
        } = {}) {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const dpr = devicePixelRatio || 1;
          let w = innerWidth,
            h = innerHeight;
          canvas.style.cssText =
            "position:fixed;inset:0;z-index:9999;pointer-events:none";
          canvas.width = w * dpr;
          canvas.height = h * dpr;
          ctx.scale(dpr, dpr);
          document.body.appendChild(canvas);

          // ãƒ†ã‚­ã‚¹ãƒˆ
          const textEl = document.createElement("div");
          textEl.textContent = "ãŠã‚ã§ã¨ã†ï¼";
          textEl.style.cssText =
            "position:fixed;left:50%;top:22%;transform:translate(-50%,-50%) scale(.9);" +
            'font:800 clamp(28px,4vw,54px)/1 "Zen Maru Gothic",system-ui;color:#fff;' +
            "text-shadow:0 6px 18px rgba(255,110,150,.55),0 0 22px rgba(255,255,255,.7);" +
            "filter:drop-shadow(0 3px 10px rgba(0,0,0,.25));opacity:0;z-index:10000;";
          document.body.appendChild(textEl);
          requestAnimationFrame(() => {
            textEl.style.transition =
              "transform .8s cubic-bezier(.2,.9,.2,1),opacity .8s";
            textEl.style.opacity = "1";
            textEl.style.transform = "translate(-50%,-50%) scale(1)";
          });

          const colors = [
            "#ff2e92",
            "#ffb86c",
            "#7af0ff",
            "#b8ff3e",
            "#ffffff",
          ];
          const shapes = ["rect", "circle", "tri", "emoji"];
          const P = [];
          function spawnBurst(cx, cy, n) {
            for (let i = 0; i < n; i++) {
              const ang = Math.random() * Math.PI * 2;
              const spd = 3 + Math.random() * 6;
              const size = 4 + Math.random() * 8;
              const shape =
                shapes[
                  Math.random() < 0.12 ? 3 : Math.floor(Math.random() * 3)
                ];
              P.push({
                x: cx,
                y: cy,
                vx: Math.cos(ang) * spd,
                vy: Math.sin(ang) * spd - 2,
                g: 0.12 + Math.random() * 0.1,
                fr: 0.007 + Math.random() * 0.01,
                rot: Math.random() * Math.PI,
                vr: (Math.random() - 0.5) * 0.25,
                size,
                color: colors[Math.floor(Math.random() * colors.length)],
                life: 1,
                shape,
                emoji: ["âœ¨", "ğŸ‰", "â­"][Math.floor(Math.random() * 3)],
              });
            }
          }
          const shots = [
            [w * 0.5, h * 0.35],
            [w * 0.15, h * 0.28],
            [w * 0.85, h * 0.28],
          ];
          for (let b = 0; b < bursts; b++) {
            setTimeout(
              () =>
                shots.forEach(([cx, cy]) =>
                  spawnBurst(cx, cy, Math.round(particles / shots.length))
                ),
              b * (duration / bursts)
            );
          }
          const start = performance.now();
          function tick(t) {
            ctx.clearRect(0, 0, w, h);
            for (const p of P) {
              p.vy += p.g;
              p.vx *= 1 - p.fr;
              p.vy *= 1 - p.fr;
              p.x += p.vx;
              p.y += p.vy;
              p.rot += p.vr;
              p.life -= 0.008;
              ctx.save();
              ctx.globalAlpha = Math.max(p.life, 0.05);
              ctx.translate(p.x, p.y);
              ctx.rotate(p.rot);
              if (p.shape === "rect") {
                ctx.fillStyle = p.color;
                ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
              } else if (p.shape === "circle") {
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(0, 0, p.size / 2, 0, Math.PI * 2);
                ctx.fill();
              } else if (p.shape === "tri") {
                ctx.fillStyle = p.color;
                const s = p.size;
                ctx.beginPath();
                ctx.moveTo(0, -s / 2);
                ctx.lineTo(-s / 2, s / 2);
                ctx.lineTo(s / 2, s / 2);
                ctx.closePath();
                ctx.fill();
              } else {
                ctx.font = `${
                  p.size * 1.6
                }px system-ui,"Apple Color Emoji","Segoe UI Emoji"`;
                ctx.fillText(p.emoji, -p.size / 2, p.size / 2);
              }
              ctx.restore();
            }
            if (
              t - start < duration ||
              P.some((p) => p.life > 0 && p.y < h + 40)
            ) {
              requestAnimationFrame(tick);
            } else {
              canvas.remove();
              textEl.style.opacity = "0";
              textEl.style.transform = "translate(-50%,-50%) scale(.96)";
              setTimeout(() => textEl.remove(), 350);
            }
          }
          requestAnimationFrame(tick);
        }

        // ===== 1æšå¼•ã =====
        $("draw").onclick = async () => {
          // â˜…è¡¨ç¤ºä¸­ã®ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚‹é–“ã¯å¼•ã‹ã›ãªã„
          if (currentId) {
            alert(
              "å…ˆã«è¡¨ç¤ºä¸­ã®ã‚«ãƒ¼ãƒ‰ã‚’ã€Œå®Œäº† / ä¿ç•™ / æ£„å´ã€ã§å‡¦ç†ã—ã¦ãã ã•ã„ã€‚"
            );
            return;
          }
          if (drawing) return;
          drawing = true;
          const btn = $("draw");
          btn.disabled = true;

          try {
            const res = await fetch(`/api/owners/${ownerId}/draw`, {
              method: "POST",
            });
            if (!res.ok) {
              const txt = await res.text();
              alert(`å¼•ã‘ã¾ã›ã‚“ã§ã—ãŸï¼š${res.status}\n${txt.slice(0, 200)}`);
              return;
            }
            const data = await res.json(); // { id, content }
            currentId = data.id;

            $("drawnContent").textContent = data.content;
            $("statusBadge").textContent = "ä¿ç•™ä¸­";
            $("drawnTime").textContent = new Date().toLocaleString();
            $("drawn").style.display = "block";

            // ç¥ç ²
            megaConfetti();

            // Xå…±æœ‰ãƒªãƒ³ã‚¯ï¼ˆçœç•¥ã›ãšå¾“æ¥é€šã‚Šï¼‰
            const shareUrl = `${location.origin}/letter.html?id=${currentId}`;
            const text = `${ownerDisplayName}ã•ã‚“ã¸ã®æŠ•æ›¸ãŒå±Šã„ãŸã‚ˆï¼\nã€Œ${[
              ...data.content,
            ]
              .slice(0, 20)
              .join("")}${[...data.content].length > 20 ? "â€¦" : ""}ã€\n`;
            const a = $("btnTweet");
            if (a) {
              a.href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(
                text
              )}&url=${encodeURIComponent(shareUrl)}`;
              a.style.display = "inline-flex";
            }

            // â˜…ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºä¸­ã¯ãƒ­ãƒƒã‚¯
            setDrawLock(true);
          } finally {
            drawing = false;
            // é€šä¿¡ã¯çµ‚ã‚ã£ãŸãŒã€ã‚«ãƒ¼ãƒ‰ãŒå‡ºã¦ã„ã‚‹é–“ã¯ãƒ­ãƒƒã‚¯ç¶­æŒ
            if (!currentId) btn.disabled = false;
          }
        };

        /* ç½®ãæ›ãˆï¼šçŠ¶æ…‹æ›´æ–°ï¼ˆå®Œäº†/æ£„å´/ä¿ç•™ï¼‰ */
        $("btnDone").onclick = () => updateCurrent("å®Œäº†");
        $("btnDrop").onclick = () => updateCurrent("æ£„å´");
        $("btnHold").onclick = () => updateCurrent("ä¿ç•™"); // APIã¯ã€Œä¿æŒã€ã«å¤‰æ›

        async function updateCurrent(label) {
          if (!currentId) return;
          const apiStatus = label === "ä¿ç•™" ? "ä¿æŒ" : label;
          const res = await fetch(
            `/api/owners/${ownerId}/letters/${currentId}/status`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ status: apiStatus }),
            }
          );
          if (!res.ok) {
            const txt = await res.text();
            alert(`æ›´æ–°å¤±æ•—ï¼š${res.status}\n${txt.slice(0, 200)}`);
            return;
          }
          $("drawn").style.display = "none";
          currentId = null;
          setDrawLock(false); // â˜…ãƒ­ãƒƒã‚¯è§£é™¤
        }

        /* ç½®ãæ›ãˆï¼šÃ—ã¨ã˜ã‚‹ï¼ˆAPIã¯å‘¼ã°ãªã„ï¼ä¿æŒã®ã¾ã¾ï¼‰ */
        $("btnClose").onclick = () => {
          $("drawn").style.display = "none";
          currentId = null; // â˜…è¡¨ç¤ºã¯æ¶ˆãˆãŸï¼æ¬¡ã‚’å¼•ã‘ã‚‹
          setDrawLock(false); // â˜…ãƒ­ãƒƒã‚¯è§£é™¤
        };

        // åˆæœŸåŒ–
        (async () => {
          const r = await fetch("/api/me");
          if (!r.ok) {
            location.href = "/login.html";
            return;
          }
          const me = await r.json();
          ownerId = me.ownerId || me.id;
          ownerDisplayName = me.displayName || "@" + ownerId;

          $("copyLink").onclick = async () => {
            const url = `${location.origin}/box.html?o=${encodeURIComponent(
              ownerId
            )}`;
            try {
              await navigator.clipboard.writeText(url);
            } catch {}
          };
        })();
      })();
    </script>
  </body>
</html>
