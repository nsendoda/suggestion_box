<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>投書一覧</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: "Yu Gothic", sans-serif;
        background: #fafafa;
        margin: 0;
        padding: 1.5rem;
        color: #333;
      }
      h1 {
        text-align: center;
        color: #ff8d8d;
        margin-bottom: 1rem;
        font-size: 1.6rem;
      }
      .toolbar {
        max-width: 700px;
        margin: 0 auto 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9rem;
      }
      .back {
        color: #ff8d8d;
        font-weight: bold;
        text-decoration: none;
      }
      .inbox-option {
        color: #666;
      }
      ul {
        list-style: none;
        padding: 0;
        max-width: 700px;
        margin: 0 auto;
      }
      li {
        background: #fff;
        border-left: 6px solid #ff8d8d;
        margin-bottom: 1rem;
        padding: 1rem 1.2rem;
        border-radius: 0.8rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        white-space: pre-wrap;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
      }
      .status-保持 {
        border-left-color: #ffb04c;
      }
      .status-完了 {
        border-left-color: #4caf50;
        opacity: 0.6;
        text-decoration: line-through;
      }
      .status-棄却 {
        border-left-color: #f44336;
        opacity: 0.6;
        text-decoration: line-through;
      }
      .badge {
        font-size: 0.8rem;
        color: #999;
        margin-right: 0.5rem;
      }
      .btn {
        padding: 0.3rem 0.9rem;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: bold;
        color: #fff;
        cursor: pointer;
      }
      .btn-done {
        background: #4caf50;
      }
      .btn-reject {
        background: #f44336;
      }
      a {
        color: #ff8d8d;
        text-decoration: none;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1 id="title">投書一覧</h1>

    <div class="toolbar">
      <a id="backLink" href="/owner.html" class="back"
        >◀︎ ダッシュボードへ戻る</a
      >
      <label id="inboxWrap" class="inbox-option" style="display: none">
        <input type="checkbox" id="chkInbox" /> inbox も表示
      </label>
    </div>

    <ul id="list"></ul>

    <script>
      const $ = (id) => document.getElementById(id);

      // ?o=ownerId があればその人の一覧。無ければ自分の一覧。
      const qs = new URLSearchParams(location.search);
      let targetOwner = qs.get("o") || ""; // 公開閲覧で使う
      let meId = null;

      async function boot() {
        // 自分情報（未ログインOK）
        try {
          const r = await fetch("/api/me");
          if (r.ok) {
            const me = await r.json();
            meId = me.ownerId || me.id || null;
          }
        } catch {}

        if (!targetOwner) targetOwner = meId || ""; // パラメータ無ければ自分。未ログインなら空のまま

        if (!targetOwner) {
          // 未ログインかつ ?o なし
          $("title").textContent = "投書一覧";
          $("list").innerHTML =
            "<li>閲覧するユーザーが指定されていません。</li>";
          $("backLink").style.display = "none";
          return;
        }

        // 表示名（なければ @id）
        let display = "@" + targetOwner;
        try {
          const pr = await fetch(
            `/api/owners/${encodeURIComponent(targetOwner)}/profile`
          );
          if (pr.ok) {
            const p = await pr.json();
            if (p.displayName) display = p.displayName;
          }
        } catch {}
        $("title").textContent = `${display} さんの投書一覧`;
        document.title = `${display}さんの投書一覧`;

        // 本人か？
        const isSelf = !!meId && meId === targetOwner;

        // 戻るリンクは本人のみ表示
        $("backLink").style.display = isSelf ? "inline" : "none";

        // inbox は noshi 本人だけ
        const canSeeInbox = isSelf && meId === "noshi";
        if (canSeeInbox) {
          $("inboxWrap").style.display = "inline-block";
          $("chkInbox").checked = qs.get("inbox") === "1";
          $("chkInbox").addEventListener("change", () => {
            const u = new URL(location.href);
            if ($("chkInbox").checked) u.searchParams.set("inbox", "1");
            else u.searchParams.delete("inbox");
            history.replaceState(null, "", u);
            load();
          });
        } else {
          $("inboxWrap").style.display = "none";
          // 他人の時は ?inbox を無視してURLからも消す
          const u = new URL(location.href);
          if (u.searchParams.has("inbox")) {
            u.searchParams.delete("inbox");
            history.replaceState(null, "", u);
          }
        }

        load();
      }

      async function load() {
        const withInbox =
          $("inboxWrap").style.display !== "none" && $("chkInbox").checked;
        let url = `/api/owners/${encodeURIComponent(targetOwner)}/letters`;
        if (withInbox) url += "?inbox=1";

        const r = await fetch(url);
        if (!r.ok) {
          const t = await r.text();
          alert(`一覧取得エラー: ${r.status}\n${t.slice(0, 200)}`);
          return;
        }
        const data = await r.json();
        const rows = Array.isArray(data) ? data : data.results;

        const list = $("list");
        list.innerHTML = "";

        for (const l of rows) {
          const li = document.createElement("li");
          const label = l.status === "保持" ? "保留" : l.status;
          li.className = `status-${l.status}`;

          const left = document.createElement("div");
          left.innerHTML = `<span class="badge">[${label}]</span>${escapeHtml(
            l.content
          )}`;
          li.appendChild(left);

          // クリックで投書単体へ
          li.style.cursor = "pointer";
          li.onclick = () => (location.href = `/letter.html?id=${l.id}`);

          list.appendChild(li);
        }
      }

      function escapeHtml(s) {
        return s.replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }

      boot();
    </script>
  </body>
</html>
