<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>投書を送る - to-sho-box</title>
  <style>
    :root{--pink:#ff8d8d;--bg:#fff8f8}
    body{font-family:"Yu Gothic",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:0;color:#333}
    .wrap{max-width:720px;margin:40px auto;padding:0 16px}
    h1{font-weight:800;letter-spacing:.02em;color:#e56d6d}
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:20px}
    textarea{width:100%;min-height:120px;padding:12px;border:1px solid #e7e7e7;border-radius:12px;font-size:15px}
    .actions{display:flex;gap:12px;align-items:center;margin-top:12px}
    .btn{appearance:none;border:none;border-radius:9999px;background:var(--pink);color:#fff;font-weight:700;padding:12px 18px;cursor:pointer}
    .hint{color:#888;font-size:12px;margin-top:6px}
    .error{padding:24px;border:1px dashed #ffb6b6;color:#c94848;background:#fff;border-radius:12px}
    a{color:var(--pink);text-decoration:none}
    .toplink{margin-top:24px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>投書を送る</h1>

    <div id="err" class="error" hidden>
      箱（ユーザーID）が指定されていません。<br />
      <div class="toplink"><a href="/">◀ トップへ戻る</a></div>
      <div class="hint">共有リンク例：<code>/box.html?o=alice</code></div>
    </div>

    <div id="form" class="card" hidden>
      <div class="hint" id="targetLabel"></div>
      <textarea id="content" maxlength="200" placeholder="200文字まででお題を送れます" required></textarea>
      <div class="actions">
        <button id="send" class="btn">送信</button>
        <div class="hint" id="status"></div>
      </div>
    </div>

    <div class="toplink"><a href="/">◀ トップへ戻る</a></div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search)
    const ownerId = (qs.get('o') || '').trim()
    const $ = (id) => document.getElementById(id)

    if (!ownerId) {
      $('err').hidden = false
    } else {
      $('form').hidden = false
      $('targetLabel').textContent = `宛先：@${ownerId} さん`
      $('send').onclick = async () => {
        const content = $('content').value.trim()
        if (!content) return
        $('send').disabled = true
        $('status').textContent = '送信中…'
        try {
          const r = await fetch(`/api/owners/${encodeURIComponent(ownerId)}/letters`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
          })
          if (!r.ok) {
            $('status').textContent = '送信に失敗しました'
            $('send').disabled = false
            return
          }
          $('content').value = ''
          $('status').textContent = '送信しました！'
        } catch (e) {
          $('status').textContent = 'ネットワークエラー'
        } finally {
          setTimeout(() => { $('status').textContent = ''; $('send').disabled = false }, 1200)
        }
      }
    }
  </script>
</body>
</html>
